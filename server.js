const express = require('express');
const proxy = require('express-http-proxy');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// ====================================================================
// Û±. Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… Ø§Ø³Ù¾ÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
// ====================================================================
const HF_SPACES = [
    'hamed744-ttspro.hf.space',   // Ø§Ø³Ù¾ÛŒØ³ Ø§ØµÙ„ÛŒ
    'hamed744-ttspro2.hf.space',  // Ø§Ø³Ù¾ÛŒØ³ Ø¯ÙˆÙ…
    'hamed744-ttspro3.hf.space'   // Ø§Ø³Ù¾ÛŒØ³ Ø³ÙˆÙ…
];

// Ù…ØªØºÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø§Ø³Ù¾ÛŒØ³ Ø¨Ø¹Ø¯ÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
let currentSpaceIndex = 0;

console.log(`âœ… Load balancer configured with ${HF_SPACES.length} target spaces.`);

// ====================================================================
// Û². Ø³Ø±ÙˆØ± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§ØªÛŒÚ© (HTML, CSS, JS) Ø´Ù…Ø§ Ø±Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
// ====================================================================
// Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
app.use(express.static(path.join(__dirname, 'public')));


// ====================================================================
// Û³. Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ ØªÙˆØ²ÛŒØ¹ Ø¨Ø§Ø± (Load Balancer)
// ====================================================================
// Ø¨Ù‡ Ø¬Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² Ù¾Ø±ÙˆÚ©Ø³ÛŒØŒ ÛŒÚ© Ù…ÛŒØ§Ù†â€ŒØ§ÙØ²Ø§Ø± (middleware) Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
// ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ ÛŒÚ© Ø§Ø³Ù¾ÛŒØ³ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ú†Ø±Ø®Ø´ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ø¯.
app.use('/gradio_api', (req, res, next) => {
    
    // Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Ù¾ÛŒØ³ Ù‡Ø¯Ù Ø§Ø² Ù„ÛŒØ³Øª
    const targetSpace = HF_SPACES[currentSpaceIndex];
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø¹Ø¯ÛŒ (Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ú†Ø±Ø®Ø´ÛŒ ÛŒØ§ Round-Robin)
    currentSpaceIndex = (currentSpaceIndex + 1) % HF_SPACES.length;
    
    // Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ú©Ø¯Ø§Ù… Ø§Ø³Ù¾ÛŒØ³ Ù…ÛŒâ€ŒØ±ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯)
    console.log(`[${new Date().toISOString()}] Forwarding request to: ${targetSpace}${req.originalUrl}`);
    
    // Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø¨Ø§ Ù‡Ø¯Ù Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©ÛŒ Ú©Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒÙ…
    proxy(targetSpace, {
        https: true, // Ø§ØªØµØ§Ù„ Ø§Ù…Ù† Ø¨Ù‡ Ù‡Ø§Ú¯ÛŒÙ†Ú¯ ÙÛŒØ³
        proxyReqPathResolver: function (proxyReq) {
            // Ù…Ø³ÛŒØ± Ú©Ø§Ù…Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            return proxyReq.originalUrl;
        },
        proxyErrorHandler: function (err, proxyRes, next) {
            console.error(`âŒ Proxy error for target ${targetSpace}:`, err);
            // Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ÛŒÚ© Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
            if (!proxyRes.headersSent) {
                proxyRes.status(503).send('Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§ Ø¨Ø¹Ø¯Ø§ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            }
        }
    })(req, res, next);
});


// ====================================================================
// Û´. Ù…Ø³ÛŒØ± Fallback Ø¨Ø±Ø§ÛŒ Single Page Application
// ====================================================================
// Ø§ÛŒÙ† Ø¨Ø®Ø´ ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ÛŒ ØºÛŒØ± Ø§Ø² Ø±ÛŒØ´Ù‡ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ø±Ø¯ØŒ
// Ù‡Ù…Ú†Ù†Ø§Ù† ÙØ§ÛŒÙ„ index.html Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯.
app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});


// ====================================================================
// Ûµ. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆØ±
// ====================================================================
app.listen(PORT, () => {
    console.log(`ðŸš€ Proxy server with load balancing is running on port ${PORT}`);
    console.log(`Your application is accessible at your Render.com URL.`);
});
