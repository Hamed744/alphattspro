<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha TTS - نسل جدید تبدیل متن به صدا</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap');
        :root {
            --app-font: 'Vazirmatn', sans-serif; --app-bg: #F8F9FC; --panel-bg: #FFFFFF;
            --panel-border: #EAEFF7; --input-bg: #F6F8FB; --input-border: #E1E7EF;
            --text-primary: #1A202C; --text-secondary: #626F86; --text-tertiary: #8A94A6;
            --accent-primary: #4A6CFA; --accent-primary-hover: #3553D6; --accent-primary-glow: rgba(74, 108, 250, 0.25);
            --accent-secondary: #0FD4A8; --accent-secondary-hover: #0DA986; --accent-secondary-glow: rgba(15, 212, 168, 0.2);
            --accent-premium: #FFC107; --accent-premium-glow: rgba(255, 193, 7, 0.3);
            --waveform-color-active: var(--accent-primary); --waveform-color-inactive: #D0D9E6; --waveform-dashed-line-color: #E0E4E9;
            --shadow-sm: 0 1px 2px 0 rgba(26, 32, 44, 0.03); --shadow-md: 0 4px 6px -1px rgba(26, 32, 44, 0.05), 0 2px 4px -2px rgba(26, 32, 44, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(26, 32, 44, 0.06), 0 4px 6px -4px rgba(26, 32, 44, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(26, 32, 44, 0.07), 0 8px 10px -6px rgba(26, 32, 44, 0.05);
            --radius-card: 24px; --radius-btn: 14px; --radius-input: 12px;
            --transition-smooth: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        html { scroll-behavior: smooth; }
        body { font-family: var(--app-font); direction: rtl; background-color: var(--app-bg); color: var(--text-primary); font-size: 16px; line-height: 1.8; margin: 0; padding: 2.5rem 0; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; overflow-x: hidden; background-image: radial-gradient(var(--text-tertiary) 0.5px, transparent 0.5px); background-size: 20px 20px; background-position: -10px -10px; }
        .app-container { max-width: 820px; width: 92%; margin: 0 auto; }
        .app-header { padding: 0.5rem 0 2.5rem 0; text-align: center; margin-bottom: 1.5rem; animation: fadeIn 0.8s 0.2s ease-out backwards; }
        .app-header h1 { font-size: 2.5em; font-weight: 900; margin: 0 0 0.8rem 0; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        .app-header p { font-size: 1.05em; color: var(--text-secondary); margin-top: 0; opacity: 0.9; font-weight: 400; line-height: 1.7; }
        .main-content { position:relative; padding: 3rem; background-color: var(--panel-bg); border-radius: var(--radius-card); box-shadow: var(--shadow-xl); border: 1px solid var(--panel-border); animation: fadeIn 0.8s 0.4s ease-out backwards; }
        .form-group { margin-bottom: 2.2rem; }
        label { display: block; font-weight: 700; color: var(--text-primary); font-size: 1.1em; margin-bottom: 1rem; }
        textarea, input[type="text"] { width: 100%; padding: 1rem 1.2rem; border-radius: var(--radius-input); border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-primary); box-shadow: var(--shadow-sm) inset; font-family: var(--app-font); font-size: 1rem; box-sizing: border-box; transition: var(--transition-smooth); }
        textarea:focus, input[type="text"]:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-primary-glow), var(--shadow-sm) inset; background-color: var(--panel-bg); }
        textarea { min-height: 120px; resize: vertical; }
        .slider-container { display: flex; align-items: center; gap: 1.5rem; }
        input[type="range"] { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--input-border); border-radius: 3px; outline: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #fff; border-radius: 50%; cursor: pointer; border: 4px solid var(--accent-primary); box-shadow: var(--shadow-md); margin-top: -9px; }
        .temperature-value { font-weight: 700; background-color: var(--input-bg); padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--input-border); min-width: 45px; text-align: center; color: var(--accent-primary); }
        .generate-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 1.1rem 1.5rem; font-size: 1.25em; font-weight: 800; background: linear-gradient(95deg, var(--accent-secondary) 0%, var(--accent-primary) 100%); color: #fff; border: none; border-radius: var(--radius-btn); cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 12px -3px var(--accent-primary-glow), 0 6px 12px -3px var(--accent-secondary-glow); }
        .generate-btn:hover:not(:disabled) { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 20px -4px var(--accent-primary-glow), 0 8px 20px -4px var(--accent-secondary-glow); }
        .generate-btn:disabled { background: var(--text-tertiary); cursor: not-allowed; box-shadow: none; opacity: 0.7; }
        .generate-btn .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.4); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none;}
        .output-section { margin-top: 3rem; display: flex; align-items: center; justify-content: center; flex-direction: column; min-height: 220px; position: relative; padding: 2rem; background-color: var(--input-bg); border-radius: var(--radius-card); border: 2px dashed var(--input-border); box-shadow: var(--shadow-sm) inset; }
        .output-section.has-content { padding: 0; background-color: transparent; border: none; min-height: auto; box-shadow: none; }
        .status-message { font-weight: 500; color: var(--text-secondary); text-align: center; font-size: 1.1em; }
        .status-message.error { color: #c53030; font-weight: 600; }
        .loading-animation-wrapper { display: none; } /* Simplified for this example */
        .audio-player-content { display: none; width: 100%; padding: 1.5rem; box-sizing: border-box; flex-direction: column; gap: 1.2rem; background-color: var(--panel-bg); border-radius: var(--radius-card); box-shadow: var(--shadow-lg); border: 1px solid var(--panel-border); animation: fadeIn 0.5s ease-out; }
        /* --- Styles for credit system --- */
        #credit-status-message { text-align: center; color: var(--text-secondary); font-weight: 600; margin-top: 1rem; opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease, transform 0.4s ease; height: 0; overflow: hidden; }
        #credit-status-message.visible { opacity: 1; transform: translateY(0); height: auto; margin-bottom: 1rem; }
        #upgrade-premium-btn { display: none; width: 100%; margin-top: 1.5rem; padding: 1rem; font-family: var(--app-font); font-size: 1.1em; font-weight: 800; color: #212529; background: linear-gradient(95deg, #FFD54F, var(--accent-premium) 100%); border: none; border-radius: var(--radius-btn); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 8px 20px -5px var(--accent-premium-glow); }
        #upgrade-premium-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 25px -5px rgba(255, 193, 7, 0.4); }
        /* Add other relevant styles from your full file here if needed */
    </style>
</head>
<body>
    <div class="app-container">
        <div id="standard-view">
            <header class="app-header"><h1>مولد صدای هوشمند آلفا</h1><p>کیفیت استودیو، قدرت هوش مصنوعی. صدایی فراتر از انتظار خلق کنید.</p></header>
            <main class="main-content">
                <form id="standard-tts-form" onsubmit="return false;">
                    <div class="form-group"><label for="text-input-standard">📝 متن اصلی</label><textarea id="text-input-standard" rows="5" placeholder="متن خود را برای تبدیل به گفتار اینجا وارد کنید..."></textarea></div>
                    <div class="form-group"><label for="prompt-input-standard">🗣️ توصیف لحن و احساس (اختیاری)</label><input type="text" id="prompt-input-standard" placeholder="مثال: با لحنی آرام و قصه‌گو"></div>
                    <div class="form-group"><label>🎤 گوینده منتخب</label><div id="selected-speaker-display"></div></div>
                    <div class="form-group"><label for="temperature-slider-standard">🌡️ خلاقیت و پویایی صدا</label><div class="slider-container"><input type="range" id="temperature-slider-standard" class="temperature-slider" min="0.1" max="1.5" step="0.05" value="0.9"><span id="temperature-value-standard" class="temperature-value">0.9</span></div></div>
                    <p id="credit-status-message"></p>
                    <button type="submit" id="generate-btn-standard" class="generate-btn"><span class="btn-text">✨ خلق صدا با آلفا</span><div class="spinner"></div></button>
                    <button type="button" id="upgrade-premium-btn">⭐️ ارتقا به نسخه کامل و نامحدود</button>
                </form>
                <div id="output-section-standard" class="output-section">
                    <div id="status-message-standard" class="status-message">صدای تولید شده در اینجا ظاهر خواهد شد.</div>
                    <div id="audio-player-content-standard" class="audio-player-content"></div>
                </div>
            </main>
        </div>
        <audio id="hidden-audio-player" style="display: none;"></audio>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const speakers = [ { id: "Charon", name: "شهاب (مرد)", desc: "صدایی قدرمند و رسا" }, { id: "Zephyr", name: "آوا (زن)", desc: "لطیف و دلنشین" }, /* ... بقیه گویندگان ... */ ];
        
        // --- STATE VARIABLES ---
        let userSubscriptionStatus = 'free'; // 'free' or 'paid'
        let userFingerprint = null;

        // --- DOM Elements ---
        const standardView = document.getElementById('standard-view');
        const generateBtn = document.getElementById('generate-btn-standard');
        const creditStatusMessage = document.getElementById('credit-status-message');
        const upgradeBtn = document.getElementById('upgrade-premium-btn');
        const mainAudioPlayer = document.getElementById('hidden-audio-player');
        // ... (سایر DOM elements)

        // --- FUNCTIONS ---

        // تابع برای تولید شناسه منحصر به فرد مرورگر
        async function getBrowserFingerprint() {
            const components = [navigator.userAgent, navigator.language, screen.width + 'x' + screen.height, new Date().getTimezoneOffset()];
            try {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                ctx.textBaseline = "top"; ctx.font = "14px 'Arial'"; ctx.textBaseline = "alphabetic"; ctx.fillStyle = "#f60"; ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = "#069"; ctx.fillText("a1b2c3d4e5f6g7h8i9j0_!@#$%^&*()", 2, 15);
                components.push(canvas.toDataURL());
            } catch (e) { components.push("canvas-error"); }
            const fingerprintString = components.join('~~~');
            let hash = 0;
            for (let i = 0; i < fingerprintString.length; i++) {
                const char = fingerprintString.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0;
            }
            return 'fp_' + Math.abs(hash).toString(16);
        }

        // تابع برای به‌روزرسانی UI بر اساس اعتبار کاربر
        async function updateUIWithServerStatus() {
            if (!userFingerprint) return;

            creditStatusMessage.textContent = 'در حال بررسی اعتبار...';
            creditStatusMessage.classList.add('visible');

            if (userSubscriptionStatus === 'paid') {
                creditStatusMessage.textContent = 'شما به نسخه نامحدود دسترسی دارید.';
                generateBtn.disabled = false;
                upgradeBtn.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/check-credit-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprint: userFingerprint, subscriptionStatus: userSubscriptionStatus })
                });

                if (!response.ok) throw new Error('Server response was not ok.');
                const result = await response.json();

                if (result.limit_reached) {
                    generateBtn.disabled = true;
                    upgradeBtn.style.display = 'block';
                    creditStatusMessage.textContent = 'اعتبار رایگان روزانه شما تمام شده است. برای استفاده نامحدود، حساب خود را ارتقا دهید.';
                } else {
                    generateBtn.disabled = false;
                    upgradeBtn.style.display = 'none';
                    creditStatusMessage.textContent = `شما ${result.credits_remaining} اعتبار رایگان برای امروز دارید.`;
                }
            } catch (error) {
                console.error("Credit check failed:", error);
                creditStatusMessage.textContent = "خطا در بررسی اعتبار. لطفاً صفحه را رفرش کنید.";
                generateBtn.disabled = true;
            }
        }
        
        // تابع برای بروزرسانی وضعیت اشتراک کاربر
        function updateUIForSubscriptionStatus(status) {
            userSubscriptionStatus = status;
            const statusText = (status === 'paid') ? 'نسخه نامحدود' : 'نسخه رایگان';
            console.log(`User status set to: ${statusText}`);
            // می‌توانید یک نشان (badge) هم برای نمایش وضعیت اضافه کنید
            updateUIWithServerStatus();
        }

        // --- EVENT LISTENERS ---

        // گوش دادن به پیام از برنامه اندروید برای تعیین وضعیت کاربر
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'USER_STATUS_RESPONSE') {
                if (event.data.error || !event.data.payload) {
                    updateUIForSubscriptionStatus('free');
                    return;
                }
                try {
                    const userObject = JSON.parse(event.data.payload);
                    // شما باید منطق خودتان را برای تشخیص کاربر پولی اینجا قرار دهید
                    // مثال: if (userObject.isPremium)
                    const isPaid = userObject && userObject.isLogin; // فرض ساده
                    updateUIForSubscriptionStatus(isPaid ? 'paid' : 'free');
                } catch (e) {
                    updateUIForSubscriptionStatus('free');
                }
            }
        });

        // کلیک روی دکمه ارتقا (به برنامه اندروید پیام می‌فرستد)
        upgradeBtn.addEventListener('click', () => {
            // شما باید URL صفحه خرید خود را اینجا قرار دهید
            const PREMIUM_URL = '#/path/to/your/premium/page';
            parent.postMessage({ type: 'NAVIGATE_TO_PREMIUM', payload: { url: PREMIUM_URL } }, '*');
        });

        // رویداد ارسال فرم
        standardView.querySelector('#standard-tts-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const generateBtn = document.getElementById('generate-btn-standard');
            const btnText = generateBtn.querySelector('.btn-text');
            const btnSpinner = generateBtn.querySelector('.spinner');
            const statusMessage = document.getElementById('status-message-standard');
            const playerContent = document.getElementById('audio-player-content-standard');

            // نمایش حالت لودینگ
            generateBtn.disabled = true;
            btnSpinner.style.display = 'inline-block';
            btnText.textContent = 'در حال پردازش...';
            playerContent.style.display = 'none';
            statusMessage.style.display = 'none';

            try {
                const textInput = document.getElementById('text-input-standard').value;
                const promptInput = document.getElementById('prompt-input-standard').value;
                const tempSlider = document.getElementById('temperature-slider-standard').value;
                // در کد کامل شما، ID گوینده را از state بگیرید
                const speakerId = "Charon"; // مثال

                if (!textInput.trim()) {
                    throw new Error('متن ورودی خالی است.');
                }
                
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textInput,
                        prompt: promptInput,
                        speaker: speakerId,
                        temperature: parseFloat(tempSlider),
                        // اطلاعات حیاتی برای بک‌اند
                        fingerprint: userFingerprint,
                        subscriptionStatus: userSubscriptionStatus
                    })
                });

                if (response.status === 429) { // اتمام اعتبار
                    const errorData = await response.json();
                    throw new Error(errorData.message || "اعتبار روزانه شما تمام شده است.");
                }

                if (!response.ok) { // سایر خطاها
                    throw new Error(await response.text() || `خطای سرور (${response.status})`);
                }
                
                // موفقیت‌آمیز
                mainAudioPlayer.src = URL.createObjectURL(await response.blob());
                playerContent.style.display = 'flex'; // یا هر منطقی برای نمایش پلیر
                updateUIWithServerStatus(); // بروزرسانی اعتبار نمایش داده شده

            } catch (error) {
                statusMessage.textContent = `خطا: ${error.message}`;
                statusMessage.style.display = 'block';
                statusMessage.classList.add('error');
                updateUIWithServerStatus(); // برای نمایش دکمه ارتقا در صورت اتمام اعتبار
            } finally {
                // بازگرداندن دکمه به حالت اولیه
                generateBtn.disabled = false;
                btnSpinner.style.display = 'none';
                btnText.textContent = '✨ خلق صدا با آلفا';
                // اگر کاربر رایگان است، دکمه را دوباره بر اساس اعتبار فعال/غیرفعال کن
                if(userSubscriptionStatus === 'free') updateUIWithServerStatus();
            }
        });

        // --- INITIALIZATION ---
        async function initializeApp() {
            userFingerprint = await getBrowserFingerprint();
            // درخواست وضعیت کاربر از برنامه اندروید
            parent.postMessage({ type: 'REQUEST_USER_STATUS' }, '*');
        }

        initializeApp();
        // بقیه کدهای UI شما مثل پلیر، مودال و... اینجا قرار می‌گیرد
    });
    </script>
</body>
</html>
