<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha TTS - Ù†Ø³Ù„ Ø¬Ø¯ÛŒØ¯ ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø¨Ù‡ ØµØ¯Ø§</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap');
        :root {
            --app-font: 'Vazirmatn', sans-serif; --app-bg: #F8F9FC; --panel-bg: #FFFFFF;
            --panel-border: #EAEFF7; --input-bg: #F6F8FB; --input-border: #E1E7EF;
            --text-primary: #1A202C; --text-secondary: #626F86; --text-tertiary: #8A94A6;
            --accent-primary: #4A6CFA; --accent-primary-hover: #3553D6; --accent-primary-glow: rgba(74, 108, 250, 0.25);
            --accent-secondary: #0FD4A8; --accent-secondary-hover: #0DA986; --accent-secondary-glow: rgba(15, 212, 168, 0.2);
            --accent-premium: #FFC107; --accent-premium-glow: rgba(255, 193, 7, 0.3);
            --waveform-color-active: var(--accent-primary); --waveform-color-inactive: #D0D9E6; --waveform-dashed-line-color: #E0E4E9;
            --shadow-sm: 0 1px 2px 0 rgba(26, 32, 44, 0.03); --shadow-md: 0 4px 6px -1px rgba(26, 32, 44, 0.05), 0 2px 4px -2px rgba(26, 32, 44, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(26, 32, 44, 0.06), 0 4px 6px -4px rgba(26, 32, 44, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(26, 32, 44, 0.07), 0 8px 10px -6px rgba(26, 32, 44, 0.05);
            --radius-card: 24px; --radius-btn: 14px; --radius-input: 12px;
            --transition-smooth: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        html { scroll-behavior: smooth; }
        body { font-family: var(--app-font); direction: rtl; background-color: var(--app-bg); color: var(--text-primary); font-size: 16px; line-height: 1.8; margin: 0; padding: 2.5rem 0; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; overflow-x: hidden; background-image: radial-gradient(var(--text-tertiary) 0.5px, transparent 0.5px); background-size: 20px 20px; background-position: -10px -10px; }
        .app-container { max-width: 820px; width: 92%; margin: 0 auto; }
        .app-header { padding: 0.5rem 0 2.5rem 0; text-align: center; margin-bottom: 1.5rem; animation: fadeIn 0.8s 0.2s ease-out backwards; }
        .app-header h1 { font-size: 2.5em; font-weight: 900; margin: 0 0 0.8rem 0; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        .app-header p { font-size: 1.05em; color: var(--text-secondary); margin-top: 0; opacity: 0.9; font-weight: 400; line-height: 1.7; }
        .main-content { position:relative; padding: 3rem; background-color: var(--panel-bg); border-radius: var(--radius-card); box-shadow: var(--shadow-xl); border: 1px solid var(--panel-border); animation: fadeIn 0.8s 0.4s ease-out backwards; }
        .form-group { margin-bottom: 2.2rem; }
        label { display: block; font-weight: 700; color: var(--text-primary); font-size: 1.1em; margin-bottom: 1rem; }
        textarea, input[type="text"] { width: 100%; padding: 1rem 1.2rem; border-radius: var(--radius-input); border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-primary); box-shadow: var(--shadow-sm) inset; font-family: var(--app-font); font-size: 1rem; box-sizing: border-box; transition: var(--transition-smooth); }
        textarea:focus, input[type="text"]:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-primary-glow), var(--shadow-sm) inset; background-color: var(--panel-bg); }
        textarea { min-height: 120px; resize: vertical; }
        .slider-container { display: flex; align-items: center; gap: 1.5rem; }
        input[type="range"] { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--input-border); border-radius: 3px; outline: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #fff; border-radius: 50%; cursor: pointer; border: 4px solid var(--accent-primary); box-shadow: var(--shadow-md); margin-top: -9px; }
        .temperature-value { font-weight: 700; background-color: var(--input-bg); padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--input-border); min-width: 45px; text-align: center; color: var(--accent-primary); }
        .generate-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 1.1rem 1.5rem; font-size: 1.25em; font-weight: 800; background: linear-gradient(95deg, var(--accent-secondary) 0%, var(--accent-primary) 100%); color: #fff; border: none; border-radius: var(--radius-btn); cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 12px -3px var(--accent-primary-glow), 0 6px 12px -3px var(--accent-secondary-glow); }
        .generate-btn:hover:not(:disabled) { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 20px -4px var(--accent-primary-glow), 0 8px 20px -4px var(--accent-secondary-glow); }
        .generate-btn:disabled { background: var(--text-tertiary); cursor: not-allowed; box-shadow: none; opacity: 0.7; }
        .generate-btn .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.4); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none;}
        .output-section { margin-top: 3rem; display: flex; align-items: center; justify-content: center; flex-direction: column; min-height: 220px; position: relative; padding: 2rem; background-color: var(--input-bg); border-radius: var(--radius-card); border: 2px dashed var(--input-border); box-shadow: var(--shadow-sm) inset; }
        .output-section.has-content { padding: 0; background-color: transparent; border: none; min-height: auto; box-shadow: none; }
        .status-message { font-weight: 500; color: var(--text-secondary); text-align: center; font-size: 1.1em; }
        .status-message.error { color: #c53030; font-weight: 600; }
        .loading-animation-wrapper { display: none; } /* Simplified for this example */
        .audio-player-content { display: none; width: 100%; padding: 1.5rem; box-sizing: border-box; flex-direction: column; gap: 1.2rem; background-color: var(--panel-bg); border-radius: var(--radius-card); box-shadow: var(--shadow-lg); border: 1px solid var(--panel-border); animation: fadeIn 0.5s ease-out; }
        /* --- Styles for credit system --- */
        #credit-status-message { text-align: center; color: var(--text-secondary); font-weight: 600; margin-top: 1rem; opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease, transform 0.4s ease; height: 0; overflow: hidden; }
        #credit-status-message.visible { opacity: 1; transform: translateY(0); height: auto; margin-bottom: 1rem; }
        #upgrade-premium-btn { display: none; width: 100%; margin-top: 1.5rem; padding: 1rem; font-family: var(--app-font); font-size: 1.1em; font-weight: 800; color: #212529; background: linear-gradient(95deg, #FFD54F, var(--accent-premium) 100%); border: none; border-radius: var(--radius-btn); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 8px 20px -5px var(--accent-premium-glow); }
        #upgrade-premium-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 25px -5px rgba(255, 193, 7, 0.4); }
        /* Add other relevant styles from your full file here if needed */
    </style>
</head>
<body>
    <div class="app-container">
        <div id="standard-view">
            <header class="app-header"><h1>Ù…ÙˆÙ„Ø¯ ØµØ¯Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¢Ù„ÙØ§</h1><p>Ú©ÛŒÙÛŒØª Ø§Ø³ØªÙˆØ¯ÛŒÙˆØŒ Ù‚Ø¯Ø±Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ. ØµØ¯Ø§ÛŒÛŒ ÙØ±Ø§ØªØ± Ø§Ø² Ø§Ù†ØªØ¸Ø§Ø± Ø®Ù„Ù‚ Ú©Ù†ÛŒØ¯.</p></header>
            <main class="main-content">
                <form id="standard-tts-form" onsubmit="return false;">
                    <div class="form-group"><label for="text-input-standard">ğŸ“ Ù…ØªÙ† Ø§ØµÙ„ÛŒ</label><textarea id="text-input-standard" rows="5" placeholder="Ù…ØªÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ú¯ÙØªØ§Ø± Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea></div>
                    <div class="form-group"><label for="prompt-input-standard">ğŸ—£ï¸ ØªÙˆØµÛŒÙ Ù„Ø­Ù† Ùˆ Ø§Ø­Ø³Ø§Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input type="text" id="prompt-input-standard" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§ Ù„Ø­Ù†ÛŒ Ø¢Ø±Ø§Ù… Ùˆ Ù‚ØµÙ‡â€ŒÚ¯Ùˆ"></div>
                    <div class="form-group"><label>ğŸ¤ Ú¯ÙˆÛŒÙ†Ø¯Ù‡ Ù…Ù†ØªØ®Ø¨</label><div id="selected-speaker-display"></div></div>
                    <div class="form-group"><label for="temperature-slider-standard">ğŸŒ¡ï¸ Ø®Ù„Ø§Ù‚ÛŒØª Ùˆ Ù¾ÙˆÛŒØ§ÛŒÛŒ ØµØ¯Ø§</label><div class="slider-container"><input type="range" id="temperature-slider-standard" class="temperature-slider" min="0.1" max="1.5" step="0.05" value="0.9"><span id="temperature-value-standard" class="temperature-value">0.9</span></div></div>
                    <p id="credit-status-message"></p>
                    <button type="submit" id="generate-btn-standard" class="generate-btn"><span class="btn-text">âœ¨ Ø®Ù„Ù‚ ØµØ¯Ø§ Ø¨Ø§ Ø¢Ù„ÙØ§</span><div class="spinner"></div></button>
                    <button type="button" id="upgrade-premium-btn">â­ï¸ Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ùˆ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯</button>
                </form>
                <div id="output-section-standard" class="output-section">
                    <div id="status-message-standard" class="status-message">ØµØ¯Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¸Ø§Ù‡Ø± Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</div>
                    <div id="audio-player-content-standard" class="audio-player-content"></div>
                </div>
            </main>
        </div>
        <audio id="hidden-audio-player" style="display: none;"></audio>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const speakers = [ { id: "Charon", name: "Ø´Ù‡Ø§Ø¨ (Ù…Ø±Ø¯)", desc: "ØµØ¯Ø§ÛŒÛŒ Ù‚Ø¯Ø±Ù…Ù†Ø¯ Ùˆ Ø±Ø³Ø§" }, { id: "Zephyr", name: "Ø¢ÙˆØ§ (Ø²Ù†)", desc: "Ù„Ø·ÛŒÙ Ùˆ Ø¯Ù„Ù†Ø´ÛŒÙ†" }, /* ... Ø¨Ù‚ÛŒÙ‡ Ú¯ÙˆÛŒÙ†Ø¯Ú¯Ø§Ù† ... */ ];
        
        // --- STATE VARIABLES ---
        let userSubscriptionStatus = 'free'; // 'free' or 'paid'
        let userFingerprint = null;

        // --- DOM Elements ---
        const standardView = document.getElementById('standard-view');
        const generateBtn = document.getElementById('generate-btn-standard');
        const creditStatusMessage = document.getElementById('credit-status-message');
        const upgradeBtn = document.getElementById('upgrade-premium-btn');
        const mainAudioPlayer = document.getElementById('hidden-audio-player');
        // ... (Ø³Ø§ÛŒØ± DOM elements)

        // --- FUNCTIONS ---

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ù…Ø±ÙˆØ±Ú¯Ø±
        async function getBrowserFingerprint() {
            const components = [navigator.userAgent, navigator.language, screen.width + 'x' + screen.height, new Date().getTimezoneOffset()];
            try {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                ctx.textBaseline = "top"; ctx.font = "14px 'Arial'"; ctx.textBaseline = "alphabetic"; ctx.fillStyle = "#f60"; ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = "#069"; ctx.fillText("a1b2c3d4e5f6g7h8i9j0_!@#$%^&*()", 2, 15);
                components.push(canvas.toDataURL());
            } catch (e) { components.push("canvas-error"); }
            const fingerprintString = components.join('~~~');
            let hash = 0;
            for (let i = 0; i < fingerprintString.length; i++) {
                const char = fingerprintString.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0;
            }
            return 'fp_' + Math.abs(hash).toString(16);
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø¹ØªØ¨Ø§Ø± Ú©Ø§Ø±Ø¨Ø±
        async function updateUIWithServerStatus() {
            if (!userFingerprint) return;

            creditStatusMessage.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±...';
            creditStatusMessage.classList.add('visible');

            if (userSubscriptionStatus === 'paid') {
                creditStatusMessage.textContent = 'Ø´Ù…Ø§ Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±ÛŒØ¯.';
                generateBtn.disabled = false;
                upgradeBtn.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/check-credit-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprint: userFingerprint, subscriptionStatus: userSubscriptionStatus })
                });

                if (!response.ok) throw new Error('Server response was not ok.');
                const result = await response.json();

                if (result.limit_reached) {
                    generateBtn.disabled = true;
                    upgradeBtn.style.display = 'block';
                    creditStatusMessage.textContent = 'Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ÛŒÚ¯Ø§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡ Ø´Ù…Ø§ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ØŒ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±ØªÙ‚Ø§ Ø¯Ù‡ÛŒØ¯.';
                } else {
                    generateBtn.disabled = false;
                    upgradeBtn.style.display = 'none';
                    creditStatusMessage.textContent = `Ø´Ù…Ø§ ${result.credits_remaining} Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø¯Ø§Ø±ÛŒØ¯.`;
                }
            } catch (error) {
                console.error("Credit check failed:", error);
                creditStatusMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.";
                generateBtn.disabled = true;
            }
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø´ØªØ±Ø§Ú© Ú©Ø§Ø±Ø¨Ø±
        function updateUIForSubscriptionStatus(status) {
            userSubscriptionStatus = status;
            const statusText = (status === 'paid') ? 'Ù†Ø³Ø®Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯' : 'Ù†Ø³Ø®Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†';
            console.log(`User status set to: ${statusText}`);
            // Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ù†Ø´Ø§Ù† (badge) Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
            updateUIWithServerStatus();
        }

        // --- EVENT LISTENERS ---

        // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù¾ÛŒØ§Ù… Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'USER_STATUS_RESPONSE') {
                if (event.data.error || !event.data.payload) {
                    updateUIForSubscriptionStatus('free');
                    return;
                }
                try {
                    const userObject = JSON.parse(event.data.payload);
                    // Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ù…Ù†Ø·Ù‚ Ø®ÙˆØ¯ØªØ§Ù† Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ú©Ø§Ø±Ø¨Ø± Ù¾ÙˆÙ„ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
                    // Ù…Ø«Ø§Ù„: if (userObject.isPremium)
                    const isPaid = userObject && userObject.isLogin; // ÙØ±Ø¶ Ø³Ø§Ø¯Ù‡
                    updateUIForSubscriptionStatus(isPaid ? 'paid' : 'free');
                } catch (e) {
                    updateUIForSubscriptionStatus('free');
                }
            }
        });

        // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø§Ø±ØªÙ‚Ø§ (Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ù¾ÛŒØ§Ù… Ù…ÛŒâ€ŒÙØ±Ø³ØªØ¯)
        upgradeBtn.addEventListener('click', () => {
            // Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ URL ØµÙØ­Ù‡ Ø®Ø±ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
            const PREMIUM_URL = '#/path/to/your/premium/page';
            parent.postMessage({ type: 'NAVIGATE_TO_PREMIUM', payload: { url: PREMIUM_URL } }, '*');
        });

        // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
        standardView.querySelector('#standard-tts-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const generateBtn = document.getElementById('generate-btn-standard');
            const btnText = generateBtn.querySelector('.btn-text');
            const btnSpinner = generateBtn.querySelector('.spinner');
            const statusMessage = document.getElementById('status-message-standard');
            const playerContent = document.getElementById('audio-player-content-standard');

            // Ù†Ù…Ø§ÛŒØ´ Ø­Ø§Ù„Øª Ù„ÙˆØ¯ÛŒÙ†Ú¯
            generateBtn.disabled = true;
            btnSpinner.style.display = 'inline-block';
            btnText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...';
            playerContent.style.display = 'none';
            statusMessage.style.display = 'none';

            try {
                const textInput = document.getElementById('text-input-standard').value;
                const promptInput = document.getElementById('prompt-input-standard').value;
                const tempSlider = document.getElementById('temperature-slider-standard').value;
                // Ø¯Ø± Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø´Ù…Ø§ØŒ ID Ú¯ÙˆÛŒÙ†Ø¯Ù‡ Ø±Ø§ Ø§Ø² state Ø¨Ú¯ÛŒØ±ÛŒØ¯
                const speakerId = "Charon"; // Ù…Ø«Ø§Ù„

                if (!textInput.trim()) {
                    throw new Error('Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
                }
                
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textInput,
                        prompt: promptInput,
                        speaker: speakerId,
                        temperature: parseFloat(tempSlider),
                        // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ú©â€ŒØ§Ù†Ø¯
                        fingerprint: userFingerprint,
                        subscriptionStatus: userSubscriptionStatus
                    })
                });

                if (response.status === 429) { // Ø§ØªÙ…Ø§Ù… Ø§Ø¹ØªØ¨Ø§Ø±
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Ø§Ø¹ØªØ¨Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡ Ø´Ù…Ø§ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                }

                if (!response.ok) { // Ø³Ø§ÛŒØ± Ø®Ø·Ø§Ù‡Ø§
                    throw new Error(await response.text() || `Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± (${response.status})`);
                }
                
                // Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²
                mainAudioPlayer.src = URL.createObjectURL(await response.blob());
                playerContent.style.display = 'flex'; // ÛŒØ§ Ù‡Ø± Ù…Ù†Ø·Ù‚ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾Ù„ÛŒØ±
                updateUIWithServerStatus(); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡

            } catch (error) {
                statusMessage.textContent = `Ø®Ø·Ø§: ${error.message}`;
                statusMessage.style.display = 'block';
                statusMessage.classList.add('error');
                updateUIWithServerStatus(); // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ø§Ø±ØªÙ‚Ø§ Ø¯Ø± ØµÙˆØ±Øª Ø§ØªÙ…Ø§Ù… Ø§Ø¹ØªØ¨Ø§Ø±
            } finally {
                // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡
                generateBtn.disabled = false;
                btnSpinner.style.display = 'none';
                btnText.textContent = 'âœ¨ Ø®Ù„Ù‚ ØµØ¯Ø§ Ø¨Ø§ Ø¢Ù„ÙØ§';
                // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³ØªØŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø¹ØªØ¨Ø§Ø± ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†
                if(userSubscriptionStatus === 'free') updateUIWithServerStatus();
            }
        });

        // --- INITIALIZATION ---
        async function initializeApp() {
            userFingerprint = await getBrowserFingerprint();
            // Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯
            parent.postMessage({ type: 'REQUEST_USER_STATUS' }, '*');
        }

        initializeApp();
        // Ø¨Ù‚ÛŒÙ‡ Ú©Ø¯Ù‡Ø§ÛŒ UI Ø´Ù…Ø§ Ù…Ø«Ù„ Ù¾Ù„ÛŒØ±ØŒ Ù…ÙˆØ¯Ø§Ù„ Ùˆ... Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
    });
    </script>
</body>
</html>
